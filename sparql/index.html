<html lang="pt-br">

<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="grafos.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.css">

    <script src="cytoscape.min.js"></script>
    <!-- <script src="https://raw.githubusercontent.com/cytoscape/cytoscape.js/refs/heads/unstable/dist/cytoscape.min.js"></script> -->
    <script src="https://unpkg.com/cytoscape-html-label@1.1.7/dist/cytoscape-html-label.js"></script>
    <script src="cytoscape-cxtmenu.js"></script>
    <!-- <script src="https://unpkg.com/cytoscape-edgehandles@4.0.1/cytoscape-edgehandles.js"></script> -->
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>

</head>

<body>
    <input type="file" id="upload-json" accept=".json" style="display: none;">
    <input type="file" id="upload-triple" accept=".ttl" style="display: none;">

    <main>
        <div class="navbar-fixed">
            <nav class="blue">
                <div class="nav-wrapper">
                    <a href="#" class="brand-logo"><img class="responsive-img" style="width: 60px;"
                            src="https://cygri.github.io/rdf-logos/svg/sparql.svg" /></a>
                    <ul class="right hide-on-med-and-down">
                        <li data-intro="If you have a .TTL file, you can upload it here and perform your queries locally."
                            data-step="4"><a href="#" onclick="uploadTriples()"><i
                                    class="material-icons left">upload</i>Upload Triples</a>
                        <li><a href="#" onclick="loadQuery()"><i class="material-icons left">upload</i>Upload Query</a>
                        </li>
                        <li><a href="#" onclick="saveQuery()"><i class="material-icons left">download</i>Export
                                Query</a>
                        </li>
                        <li><a href="#" onclick="seeSparqlQuery()"><i class="material-icons left">query_stats</i>View
                                SPARQL Query</a></li>
                        <!-- <li><a href="login.html"><i class="material-icons left">logout</i>Logout</a></li> -->
                    </ul>
                </div>
            </nav>
        </div>
        <div class="row blue darken-4">
            <form class="col s12">
                <div class="row">
                    <div class="input-field col s2">
                        <div class="switch">
                            <label for="auto-layout" class="white-text">Auto layout:</label>
                            <label class="white-text"
                                data-intro="Here you can choose whether to manually organize the layout or have it automatically arranged."
                                data-step="5">
                                Off
                                <input type="checkbox" id="auto-layout" checked>
                                <span class="lever"></span>
                                On
                            </label>
                        </div>
                    </div>
                    <div class="input-field col s3">
                        <i class="material-icons prefix white-text">search</i>
                        <input data-intro="Start typing your search query here. Then, click on the desired result"
                            data-step="1" id="input-busca-elementos" type="text" class="autocomplete white-text">
                        <label for="input-busca-elementos" class="white-text">Search</label>
                    </div>
                    <div class="input-field col s1">
                        <input
                            data-intro="Here you can specify the number of results you want to display. Remember, the more results you request, the slower the response time"
                            data-step="2" id="input-max-results" type="number" class="white-text" value="150">
                        <label for="input-max-results" class="white-text">Max Results</label>
                    </div>
                    <div class="input-field col s6 right">
                        <i class="material-icons prefix white-text">link</i>
                        <input data-intro="Here you can specify which SPARQL endpoint to use for querying your data."
                            data-step="3" id="input-endpoint-sparql" type="text" class="white-text"
                            value="CampeonatoBrasileiro2023">
                        <label for="input-endpoint-sparql" class="white-text">SPARQL endpoint</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col s6">
                        <button id="new-query-button" class="btn waves-effect waves-light" type="button"
                            onclick="newQuery()">
                            <i class="material-icons left">refresh</i> New Query
                        </button>
                        <!-- <button id="add-variable-btn" class="btn waves-effect waves-light" type="button"
                            onclick="addNewVariable()" data-intro="Another way to start is adding a new variable here."
                            data-step="6">
                            <i class="material-icons left">add</i> Add Variable
                        </button> -->
                    </div>
                    <div class="col s6 right-align">
                        <button id="run-query-btn" class="btn waves-effect waves-light" type="button"
                            onclick="runQuery()"
                            data-intro="You can view your results by clicking here or by selecting the node with the '?' symbol."
                            data-step="7">
                            <i class="material-icons left">play_arrow</i> Run Query
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div id="cy" style="width: 100%; height: 90%;"
            data-intro="Finally, this is where you can construct your queries!" data-step="8"></div>

        <div id="grid-resultado-consulta" class="modal bottom-sheet" style="cursor: pointer;">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text right">x</a>
            <div class="modal-content">
                <h4>Query results</h4>

                <div class="input-field col s3">
                    <i class="material-icons prefix blue-text">search</i>
                    <input id="table-search-input" type="text" class="">
                    <label for="table-search-input" class="blue-text">Search</label>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Label</th>
                        </tr>
                    </thead>

                    <tbody id="table-results-body">

                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text">Close</a>
            </div>
        </div>

        <div id="modal-sparql" class="modal">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text right">x</a>
            <div class="modal-content">
                <h4>SPARQL Query</h4>
                <pre><code id="modal-sparql-content"></code></pre>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text">Close</a>
            </div>
        </div>

        <div id="modal-change-value" class="modal">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text right">x</a>
            <div class="modal-content">
                <h4>Change value</h4>
                <div id="modal-change-value-content">

                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat blue white-text">Close</a>
            </div>
        </div>

    </main>
</body>


<script>
    const env = 'prod'; //dev

    const url = {
        dev: 'http://localhost:5242',
        prod: 'https://sparql-query-easy.azurewebsites.net'
    };

    document.getElementById('table-search-input').addEventListener('keyup', function () {
        var searchValue = this.value.toLowerCase();
        var tableRows = document.querySelectorAll('#table-results-body tr');

        tableRows.forEach(function (row) {
            var rowValues = row.textContent.toLowerCase();
            if (rowValues.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    window.onload = function () {
        introJs().start();
    };

    var searches = {};
    var trData = {};
    var cy = null;

    function abrirModal() {
        $('#grid-resultado-consulta').modal('open');
    }

    function abrirModalSparql() {
        $('#modal-sparql').modal('open');
    }

    function abrirModalChangeValue() {
        $('#modal-change-value').modal('open');
    }

    function getLimit() {
        let limitInputValue = +$("#input-max-results").val();
        let limit = 20;

        if (!isNaN(limitInputValue)) {
            limit = limitInputValue;
        }

        return limit;
    }

    function getAllNodes() {
        let nodes = [];
        let conjuntos = cy.elements().components();

        for (var j = 0; j < conjuntos.length; j++) {
            for (var i = 0; i < conjuntos[j].length; i++) {
                var item = conjuntos[j][i];
                if (item.data('id').includes('?')) {
                    continue;
                }

                nodes.push(
                    item.data('id')
                )
            }
        }

        return nodes;
    }

    function seeSparqlQuery() {
        let conjuntos = cy.elements().components();
        let conjuntoQuery = 0;
        let variableName = '';
        let filters = [];

        for (var i = 0; i < conjuntos[conjuntoQuery].length; i++) {
            var item = conjuntos[conjuntoQuery][i];
            if (item.data('source') && item.data('target')) {
                if (item.data('source').includes('?')) {
                    variableName = item.data('source');
                }

                if (item.data('target').includes('?')) {
                    variableName = item.data('target');
                }

                if (item.data('id').includes('?')) {
                    variableName = item.data('id');
                }

                // Busca o valor dos elementos com o id do `source` e `target`
                let sourceNode = cy.getElementById(item.data('source'));
                let targetNode = cy.getElementById(item.data('target'));
                let sourceValue = sourceNode.data('value') || item.data('source'); // Pega `value` ou `id`
                let targetValue = targetNode.data('value') || item.data('target'); // Pega `value` ou `id`
                let targetFilter = targetNode.data('filterType') || null

                // Adiciona o filtro com os valores dos nós `source` e `target`
                filters.push({
                    subject: sourceValue,
                    predicate: item.data('nodeId'),
                    object: targetValue,
                    filterType: targetFilter ? +targetFilter : null
                });
            }
        }

        //
        $.ajax({
            url: `${url[env]}/api/query/sparql`,
            type: 'post',
            cache: false,
            data: JSON.stringify({
                "endpointUrl": $("#input-endpoint-sparql").val(),
                "where": filters,
                "variableName": variableName,
                "limit": getLimit()
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                console.log(data.data)
                $("#modal-sparql-content").html(escapeHTML(data.data));
                abrirModalSparql();
            },
            error: function (err) {
                $("#modal-sparql-content").html("Try again later.");
                console.log(err);
                abrirModalSparql();
            }
        });
    }

    function getElementInfo(elementId) {
        $.ajax({
            url: `${url[env]}/api/query/relationships`,
            type: 'post',
            cache: false,
            data: JSON.stringify({
                "endpointUrl": $("#input-endpoint-sparql").val(),
                "id": elementId
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                let linhas = "";
                for (let i = 0; i < data.data.length; i++) {
                    trData[i] = {
                        subjectId: elementId,
                        predicateId: data.data[i].propertyId,
                        predicateLabel: data.data[i].propertyLabel,
                        isLiteral: data.data[i].propertyType == "label" || data.data[i].propertyLabel == "image"
                    };
                    let linha = `<tr onclick='getRelationshipValue(${i})'><td>${escapeHTML(data.data[i].propertyId)}</td><td>${data.data[i].propertyLabel}</td></tr>`
                    linhas += linha;
                }

                let primeiraLinha = '';
                if (false) {
                    trData["var"] = {
                        subjectId: elementId,
                        predicateId: '?node_' + (new Date().getTime()),
                        predicateLabel: '?',
                        isLiteral: false,
                    }

                    primeiraLinha = `<tr class='green lighten-3' onclick='getRelationshipValue("var")'><td>Add variable</td><td></td></tr>`
                }

                $("#table-results-body").html(primeiraLinha + linhas);

                abrirModal();
            },
            error: function (err) {
                $("#table-results-body").html("Try again later.");
                console.log(err);
                abrirModal();
            }
        });
    }

    //TODO: Conectar o node "any" com a nova prop que veio a partir dela (default)

    function getQuery(variableName, filters, showDefault, anotherAction) {
        let method = anotherAction || 'replaceNodeVariable';

        $.ajax({
            url: `${url[env]}/api/query`,
            type: 'post',
            cache: false,
            data: JSON.stringify({
                "endpointUrl": $("#input-endpoint-sparql").val(),
                "where": filters,
                "variableName": variableName,
                "limit": getLimit()
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                let linhas = "";
                for (let i = 0; i < data.data.length; i++) {
                    trData[i] = {
                        variableName: variableName,
                        nodeId: data.data[i].propertyId,
                        nodeLabel: data.data[i].propertyLabel,
                        propertyType: data.data[i].propertyType,
                        propertyClass: data.data[i].propertyClass
                    };

                    if (anotherAction) {
                        //trData[i].variableName = '?node_' + (new Date().getTime());
                        trData[i].subjectId = variableName;
                        trData[i].predicateId = data.data[i].propertyId;
                        trData[i].predicateLabel = data.data[i].propertyLabel;
                        trData[i].isLiteral = data.data[i].propertyType == "label" || data.data[i].propertyLabel == "image"
                    }

                    let linha = `<tr onclick='${method}(${i})'><td>${escapeHTML(data.data[i].propertyId)}</td><td>${data.data[i].propertyLabel}</td></tr>`
                    linhas += linha;
                }

                let primeiraLinha = '';
                if (false) { //showDefault
                    trData["default"] = {
                        variableName: variableName,
                        nodeId: '?default_' + (new Date().getTime()),
                        nodeLabel: '** Any **',
                        propertyType: 'default',
                        propertyClass: data.data[0].propertyClass //sempre vai ser igual a class de todas as respostas
                    }
                    primeiraLinha = `<tr class='green lighten-3' onclick='replaceNodeVariable("default")'><td>Default</td><td>Default</td></tr>`
                }

                $("#table-results-body").html(primeiraLinha + linhas);

                abrirModal();
            },
            error: function (err) {
                $("#table-results-body").html("Try again later.");
                console.log(err);
                abrirModal();
            }
        });
    }

    function getRelationshipValue(nodeLine) {
        let parameters = trData[nodeLine];

        if(nodeLine == "var") {
           //validar como fazer
        }

        $.ajax({
            url: `${url[env]}/api/query/relationship-value`,
            type: 'post',
            cache: false,
            data: JSON.stringify({
                "endpointUrl": $("#input-endpoint-sparql").val(),
                "subjectId": parameters.subjectId,
                "predicateId": parameters.predicateId,
                "isLiteral": parameters.isLiteral
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                if (data.data.length == 1) {
                    data.data.forEach(function (item, index) {
                        addNodeWithRelationship(cy,
                            item.propertyId,
                            item.propertyLabel,
                            item.propertyType,
                            parameters.subjectId,
                            parameters.predicateId,
                            parameters.predicateLabel,
                            null,
                            index
                        )
                    });
                } else {
                    addNodeWithRelationship(cy,
                        '?node_' + (new Date().getTime()),
                        `${data.data.length} resultados`,
                        'many-results',
                        parameters.subjectId,
                        parameters.predicateId,
                        parameters.predicateLabel
                    )
                }

                $('#grid-resultado-consulta').modal('close');
            },
            error: function (err) {
                console.log(err);
            }
        });
    }

    function getRelationshipValueChange(subject, predicate, predicateLabel) {
        $.ajax({
            url: `${url[env]}/api/query/relationship-value`,
            type: 'post',
            cache: false,
            data: JSON.stringify({
                "endpointUrl": $("#input-endpoint-sparql").val(),
                "subjectId": subject,
                "predicateId": predicate,
                "isLiteral": true
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            success: function (data) {
                if (data.data.length == 1) {
                    data.data.forEach(function (item, index) {
                        addNodeWithRelationship(cy,
                            item.propertyId,
                            item.propertyLabel,
                            item.propertyType,
                            subject,
                            predicate,
                            predicateLabel,
                            null,
                            index
                        )
                    });
                } else {
                    addNodeWithRelationship(cy,
                        '?node_' + (new Date().getTime()),
                        `${data.data.length} resultados`,
                        'many-results',
                        subject,
                        predicate,
                        predicateLabel
                    )
                }

                $('#grid-resultado-consulta').modal('close');
            },
            error: function (err) {
                console.log(err);
            }
        });
    }

    function replaceNodeVariable(nodeLine) {
        let parameters = trData[nodeLine];

        replaceWithNewNode(cy,
            parameters.variableName,
            parameters.nodeId,
            parameters.nodeLabel,
            parameters.propertyType,
            parameters.propertyClass
        )

        $('#grid-resultado-consulta').modal('close');
    }

    function saveQuery() {
        let queryData = cy.json();
        let jsonData = JSON.stringify(queryData)

        var blob = new Blob([jsonData], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "query_exported.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadQuery() {
        var input = document.getElementById("upload-json");
        input.click();
    }

    document.getElementById("upload-json").addEventListener("change", function () {
        if (this.files.length > 0) {
            var arquivo = this.files[0];

            var reader = new FileReader();
            reader.onload = function (e) {
                let savedCyData = JSON.parse(e.target.result);

                if (savedCyData.elements && savedCyData.elements.nodes) {
                    cy.json({
                        elements: savedCyData.elements
                    });
                } else {
                    alert('O JSON informado não é válido.')
                }
            };
            reader.readAsText(arquivo);
        } else {
            cy.json({
                elements: {}
            });
        }
    });

    function uploadTriples() {
        var input = document.getElementById("upload-triple");
        input.click();
    }

    document.getElementById("upload-triple").addEventListener("change", function () {
        if (this.files.length > 0) {
            var arquivo = this.files[0];

            var reader = new FileReader();
            reader.onload = function (e) {

                var formData = new FormData();
                formData.append("ttlFile", arquivo);

                $.ajax({
                    url: `${url[env]}/api/local-database`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        $("#input-endpoint-sparql").val(response.data)
                    },
                    error: function (error) {
                        alert('Erro no upload: ' + error.responseText);
                    }
                });
            };

            reader.readAsText(arquivo);
        } else {
            console.log('Nenhum arquivo foi selecionado.');
        }
    });

    $(document).ready(function () {
        $.get(`${url[env]}/health`, function (data, status) {
            console.log("API warmup...: " + data + "\nStatus: " + status);
        });


        $('#grid-resultado-consulta').modal();
        $('#modal-sparql').modal();
        $("#modal-change-value").modal();
        $("#input-busca-elementos").autocomplete();
        var debounceTimer;
        $("#input-busca-elementos").on("input change", function () {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () {
                $.ajax({
                    url: `${url[env]}/api/query/search`,
                    type: 'post',
                    cache: false,
                    data: JSON.stringify({
                        "endpointUrl": $("#input-endpoint-sparql").val(),
                        "search": $("#input-busca-elementos").val(),
                        "limit": getLimit()
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    success: function (data) {
                        var result = {};
                        data.data.forEach(function (item) {
                            result[item.propertyLabel] = null;
                            searches[item.propertyLabel] = item;
                        });

                        $("#input-busca-elementos").autocomplete("updateData", result);
                        $("#input-busca-elementos").autocomplete("open");
                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }, 500);
        });

        $(".autocomplete-content").on("click", function () {
            var text = $("#input-busca-elementos").val();

            var allNodes = getAllNodes();

            const promises = allNodes.flatMap(node => [
                verifyAlreadyExistsNodeAndAdd(searches[text].propertyId, text, node, false),
                verifyAlreadyExistsNodeAndAdd(searches[text].propertyId, text, node, true)
            ]);

            Promise.all(promises).then(results => {
                if (results.every(result => result === false)) {
                    addNode(cy, searches[text].propertyId, text)
                }
            });

            $("#input-busca-elementos").val("");
        });

        $("#auto-layout").on("change", function () {
            let autoLayout = $("#auto-layout").is(":checked");
            if (autoLayout)
                cy.layout({
                    name: 'cose',
                }).run();
        })
    });

    function verifyAlreadyExistsNodeAndAdd(newNodeId, newNodeText, existingNode, invert) {
        return new Promise((resolve) => {
            $.ajax({
                url: `${url[env]}/api/query`,
                type: 'post',
                cache: false,
                data: JSON.stringify({
                    "endpointUrl": $("#input-endpoint-sparql").val(),
                    "where": [
                        {
                            "subject": invert ? existingNode : newNodeId,
                            "predicate": "?predicate",
                            "object": invert ? newNodeId : existingNode,
                        }
                    ],
                    "variableName": "?predicate",
                    "limit": 1,
                    "ignoreWikidata": false
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (data) {
                    if (!data.data.length) {
                        resolve(false);
                        return;
                    }

                    let predicate = data.data[0];

                    addNodeWithRelationship(cy,
                        newNodeId,
                        newNodeText,
                        'node',
                        existingNode,
                        predicate.propertyId,
                        predicate.propertyLabel,
                        invert ? existingNode : newNodeId
                    );

                    resolve(true);
                },
                error: function (err) {
                    console.log(err);
                    resolve(false);
                }
            });
        });

    }

    function newQuery() {
        cy.elements().remove();
    }

    function addNewVariable() {
        let autoLayout = $("#auto-layout").is(":checked");
        let newNodeVarId = '?node_' + (new Date().getTime());

        cy.add({
            group: 'nodes',
            data: { id: newNodeVarId, value: newNodeVarId, label: '?', type: 'variable' }
        });

        if (autoLayout)
            cy.layout({ name: 'cose' }).run();
    }

    function showIntroAlert(name, text) {
        if (!localStorage.getItem(name)) {
            const newIntro = introJs();
            newIntro.setOptions({
                steps: [
                    {
                        intro: text
                    }
                ],
                showBullets: false,
                exitOnOverlayClick: true
            });
            newIntro.start();

            localStorage.setItem(name, 'true');
        }
    }

    function runQuery() {
        let conjuntos = cy.elements().components();
        let conjuntoQuery = 0;
        let variableName = '';
        let filters = [];

        if(!conjuntos[conjuntoQuery] || !conjuntos[conjuntoQuery].length) {
            showIntroAlert(new Date().getTime(), 'You can add at least one node');
            return;
        }

        for (var i = 0; i < conjuntos[conjuntoQuery].length; i++) {
            var item = conjuntos[conjuntoQuery][i];

            if ((item.data('source') && item.data('target')) || (item.data('id') && !item.data('source') && !item.data('target'))) {

                if (item.data('source') && item.data('source').includes('?')) {
                    variableName = item.data('source');
                }

                if (item.data('target') && item.data('target').includes('?')) {
                    variableName = item.data('target');
                }

                if (item.data('id') && item.data('id').includes('?')) {
                    variableName = item.data('id');
                }

                if (!item.data('source') && !item.data('nodeId') && !item.data('target')) continue;

                // Busca o valor dos elementos com o id do `source` e `target`
                let sourceNode = cy.getElementById(item.data('source'));
                let targetNode = cy.getElementById(item.data('target'));
                let sourceValue = sourceNode.data('value') || item.data('source'); // Pega `value` ou `id`
                let targetValue = targetNode.data('value') || item.data('target'); // Pega `value` ou `id`
                let targetFilter = targetNode.data('filterType') || null

                // Adiciona o filtro com os valores dos nós `source` e `target`
                filters.push({
                    subject: sourceValue,
                    predicate: item.data('nodeId') || '?empty_' + (new Date().getTime()),
                    object: targetValue,
                    filterType: targetFilter ? +targetFilter : null
                });
            }
        }

        if(!variableName){
            showIntroAlert(new Date().getTime(), 'You can add at least one variable node');
            return;
        }

        getQuery(variableName, filters, true);
    }

    //-------------------- cyto

    function getNodeColor(node) {
        let nodeColors = {
            'variable': '#A9D18E',
            'label-filter': '#7030A0',
            'label': 'pink',
            'default': '#FDD835'
        };

        if(node.data('color')) return '#999999ff';

        return nodeColors[node.data('type') ?? ''] ?? '#4472C4';
    }

    function addNode(theCy, id, text) {
        let autoLayout = $("#auto-layout").is(":checked");
        theCy.add({ group: 'nodes', data: { id: id, value: id, label: text, type: 'node', position: { x: 200, y: 200 } } })//
        if (autoLayout)
            theCy.layout({ name: 'cose' }).run();

        showIntroAlert('newNode', 'You can view more details about this new node by clicking on it.');
    }

    function replaceWithNewNode(theCy, varName, nodeId, nodeLabel, propertyType, propertyClass) {
        let oldElement = theCy.getElementById(varName);
        let oldId = varName;
        let nodeType = propertyType == 'text' || nodeId == nodeLabel ? 'label' : 'node';
        var nodeValue = nodeId;
        if (propertyType == 'default') {
            nodeType = 'default'
            nodeValue = propertyClass;
        }
        let newData = { id: nodeId, value: nodeValue, label: nodeLabel, type: nodeType }
        var oldNodePosition = oldElement.position();

        cy.add({
            group: 'nodes',
            data: newData,
            position: oldNodePosition
        });

        cy.edges().forEach(function (edge) {
            if (edge.data('source') === oldId) {
                let oldEdgeId = edge.data('id');
                let oldEdgeTarget = edge.data('target');
                let oldEdgeLabel = edge.data('label');
                let oldEdgeNodeId = edge.data('nodeId');
                edge.remove();
                cy.add(
                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: nodeId, target: oldEdgeTarget } }
                )

                cy.$('#' + oldEdgeTarget).remove();
                getRelationshipValueChange(nodeId, oldEdgeNodeId, oldEdgeLabel)
            }

            if (edge.data('target') === oldId) {
                let oldEdgeId = edge.data('id');
                let oldEdgeSource = edge.data('source');
                let oldEdgeLabel = edge.data('label');
                let oldEdgeNodeId = edge.data('nodeId');
                edge.remove();
                cy.add(
                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: oldEdgeSource, target: nodeId } }
                )
            }
        });

        oldElement.remove();
    }

    function addNodeWithRelationship(theCy, id, text, type, sourceNodeId, predicateId, predicateLabel, theSubject, predicateIndex) {
        let autoLayout = $("#auto-layout").is(":checked");
        let theSource = theSubject || sourceNodeId;
        let theTarget = theSource == sourceNodeId ? id : sourceNodeId;

        let types = {
            text: 'label',
            'many-results': 'variable'
        }

        let nodeType = types[type] || "node";
        let manyColor = type == 'many-results';
        let newText = predicateLabel == "image" ? "Ver imagem" : text;
        let isLink = predicateLabel == "image";
        theCy.add([
            { group: 'nodes', data: { id: id, value: id, label: newText, type: nodeType, isLink: isLink, href: text, color: manyColor ? 'gray': ''  }, position: { x: 200, y: 200 } },
            { group: 'edges', data: { nodeId: predicateId, id: predicateId + predicateIndex, label: predicateLabel, source: theSource, target: theTarget } }
        ]);

        if (autoLayout)
            theCy.layout({
                name: 'cose',
            }).run();

    }

    document.addEventListener("DOMContentLoaded", function () {
        cy = cytoscape({
            container: document.getElementById('cy'),
            zoomingEnabled: true,
            userZoomingEnabled: false,
            maxZoom: 1,
            elements: [
                // { "data": { "id": "Atleta", "label": "Atleta" } },
                // { "data": { "id": "Campeonato", "label": "Campeonato" } },
                // { "data": { "id": "Classificacao", "label": "Classificacao" } },
                // { "data": { "id": "Equipe", "label": "Equipe" } },
                // { "data": { "id": "Estadio", "label": "Estadio" } },
                // { "data": { "id": "Gol", "label": "Gol" } },
                // { "data": { "id": "Partida", "label": "Partida" } },
                // { "data": { "id": "Rodada", "label": "Rodada" } },

                // { "data": { "id": "competePor", "source": "Atleta", "target": "Equipe", "label": "competePor" } },
                // { "data": { "id": "formadaPor", "source": "Equipe", "target": "Atleta", "label": "formadaPor" } },
                // { "data": { "id": "marcaGol", "source": "Atleta", "target": "Gol", "label": "marcaGol" } },
                // { "data": { "id": "marcadoPor", "source": "Gol", "target": "Atleta", "label": "marcadoPor" } },
                // { "data": { "id": "indicaPosicao", "source": "Classificacao", "target": "Equipe", "label": "indicaPosicao" } },
                // { "data": { "id": "possuiClassificacao", "source": "Equipe", "target": "Classificacao", "label": "possuiClassificacao" } },
                // { "data": { "id": "refereSeA", "source": "Classificacao", "target": "Campeonato", "label": "refere-se" } },
                // { "data": { "id": "classifica", "source": "Campeonato", "target": "Classificacao", "label": "classifica" } },
                // // { "data": { "id": "classificadoLibertadores", "source": "Classificacao", "target": "classificadoLibertadores_val", "label": "classificadoLibertadores" } },
                // // { "data": { "id": "possuiNome", "source": "Atleta", "target": "possuiNome_val", "label": "possuiNome" } },
                // // { "data": { "id": "classificadoSulamericana", "source": "Classificacao", "target": "classificadoSulamericana_val", "label": "classificadoSulamericana" } },
                // // { "data": { "id": "incluiDerrotas", "source": "Classificacao", "target": "incluiDerrotas_val", "label": "incluiDerrotas" } },
                // // { "data": { "id": "incluiEmpates", "source": "Classificacao", "target": "incluiEmpates_val", "label": "incluiEmpates" } },
                // // { "data": { "id": "incluiGolsContra", "source": "Classificacao", "target": "incluiGolsContra_val", "label": "incluiGolsContra" } },
                // // { "data": { "id": "incluiGolsPro", "source": "Classificacao", "target": "incluiGolsPro_val", "label": "incluiGolsPro" } },
                // // { "data": { "id": "incluiPontuacao", "source": "Classificacao", "target": "incluiPontuacao_val", "label": "incluiPontuacao" } },
                // // { "data": { "id": "incluiVitorias", "source": "Classificacao", "target": "incluiVitorias_val", "label": "incluiVitorias" } },
                // // { "data": { "id": "incluiSaldoGols", "source": "Classificacao", "target": "incluiSaldoGols_val", "label": "incluiSaldoGols" } },
                // // { "data": { "id": "indicaColocacao", "source": "Classificacao", "target": "indicaColocacao_val", "label": "indicaColocacao" } },
                // // { "data": { "id": "rebaixado", "source": "Classificacao", "target": "rebaixado_val", "label": "rebaixado" } },
               
                // // { "data": { "id": "marcadoNoMinuto", "source": "Gol", "target": "marcadoNoMinuto_val", "label": "marcadoNoMinuto" } },
                // // { "data": { "id": "marcadoNoPrimeiroTempo", "source": "Gol", "target": "marcadoNoPrimeiroTempo_val", "label": "marcadoNoPrimeiroTempo" } },
                // { "data": { "id": "marcadoEm", "source": "Gol", "target": "Partida", "label": "marcadoEm" } },
                // // { "data": { "id": "foiContra", "source": "Gol", "target": "foiContra_val", "label": "foiContra" } },
                // { "data": { "id": "tem", "source": "Partida", "target": "Gol", "label": "tem" } },

                // { "data": { "id": "ocorreDurante", "source": "Rodada", "target": "Campeonato", "label": "ocorreDurante" } },
                // { "data": { "id": "participaDe", "source": "Equipe", "target": "Campeonato", "label": "participaDe" } },
                // { "data": { "id": "compostoPelaEquipe", "source": "Equipe", "target": "Campeonato", "label": "compostoPelaEquipe" } },
                // { "data": { "id": "compostoPor", "source": "Campeonato", "target": "Rodada", "label": "compostoPor" } },
                // // // { "data": { "id": "disputadoAoLongoDoAno", "source": "Campeonato", "target": "disputadoAoLongoDoAno_val", "label": "disputadoAoLongoDoAno" } },
                

                // { "data": { "id": "contemPartida", "source": "Rodada", "target": "Partida", "label": "contemPartida" } },
                // { "data": { "id": "ocorreEm", "source": "Partida", "target": "Rodada", "label": "ocorreEm" } },
                // // // { "data": { "id": "possuiIdentificacao", "source": "Rodada", "target": "possuiIdentificacao_val", "label": "possuiIdentificacao" } },
                // // // { "data": { "id": "possuiNumero", "source": "Rodada", "target": "possuiNumero_val", "label": "possuiNumero" } },
                
                // { "data": { "id": "realizadaEm", "source": "Partida", "target": "Estadio", "label": "realizadaEm" } },
                // { "data": { "id": "recebe", "source": "Estadio", "target": "Partida", "label": "recebe" } },
                // { "data": { "id": "temMandante", "source": "Partida", "target": "Equipe", "label": "temMandante" } },
                // { "data": { "id": "temVisitante", "source": "Partida", "target": "Equipe", "label": "temVisitante" } },
                // { "data": { "id": "manda", "source": "Equipe", "target": "Partida", "label": "manda" } },
                // { "data": { "id": "visita", "source": "Equipe", "target": "Partida", "label": "visita" } },
                // { "data": { "id": "classificadoLibertadores_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "classificadoSulamericana_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "disputadoAoLongoDoAno_val", "label": "positiveInteger", "type": "label" } },
                // { "data": { "id": "foiContra_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "incluiDerrotas_val", "label": "int", "type": "label" } },
                // { "data": { "id": "incluiEmpates_val", "label": "int", "type": "label" } },
                // { "data": { "id": "incluiGolsContra_val", "label": "int", "type": "label" } },
                // { "data": { "id": "incluiGolsPro_val", "label": "int", "type": "label" } },
                // { "data": { "id": "incluiPontuacao_val", "label": "int", "type": "label" } },
                // { "data": { "id": "incluiVitorias_val", "label": "positiveInteger", "type": "label" } },
                // { "data": { "id": "incluiSaldoGols_val", "label": "positiveInteger", "type": "label" } },
                // { "data": { "id": "indicaColocacao_val", "label": "positiveInteger", "type": "label" } },
                // { "data": { "id": "marcadoNoMinuto_val", "label": "string", "type": "label" } },
                // { "data": { "id": "marcadoNoPrimeiroTempo_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "placarMandante", "source": "Partida", "target": "placarMandante_val", "label": "placarMandante" } },
                // { "data": { "id": "placarMandante_val", "label": "int", "type": "label" } },
                // { "data": { "id": "placarVisitante", "source": "Partida", "target": "placarVisitante_val", "label": "placarVisitante" } },
                // { "data": { "id": "placarVisitante_val", "label": "int", "type": "label" } },
                // { "data": { "id": "possuiIdentificacao_val", "label": "string", "type": "label" } },
                //  { "data": { "id": "possuiNome_val", "label": "string", "type": "label" } },
                // { "data": { "id": "possuiNumero_val", "label": "positiveInteger", "type": "label" } },
                // { "data": { "id": "possuiPlacar", "source": "Partida", "target": "possuiPlacar_val", "label": "possuiPlacar" } },
                // { "data": { "id": "possuiPlacar_val", "label": "string", "type": "label" } },
                // { "data": { "id": "realizadaNaData", "source": "Partida", "target": "realizadaNaData_val", "label": "realizadaNaData" } },
                // { "data": { "id": "realizadaNaData_val", "label": "dateTime", "type": "label" } },
                // { "data": { "id": "vitoriaMandante", "source": "Partida", "target": "vitoriaMandante_val", "label": "vitoriaMandante" } },
                // { "data": { "id": "vitoriaMandante_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "empate", "source": "Partida", "target": "empate_val", "label": "empate" } },
                // { "data": { "id": "empate_val", "label": "boolean", "type": "label" } },
                // { "data": { "id": "rebaixado_val", "label": "boolean", "type": "label" } }
            ]
            ,

            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': getNodeColor,
                        'width': '120px',
                        'shape': function (node) {
                            var type = node.data('type');
                            var labelTypes = ['label', 'label-filter'];
                            return labelTypes.includes(type) ? 'square' : 'ellipse';
                        },
                        'height': function (node) {
                            var type = node.data('type');
                            var labelTypes = ['label', 'label-filter'];
                            return labelTypes.includes(type) ? '50px' : '120px';
                        }
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 3,
                        'target-arrow-shape': 'triangle',
                        'line-color': '#4472C4',
                        'target-arrow-color': '#4472C4',
                        'curve-style': 'bezier'
                    }
                }
            ],

            layout: {
                //name: 'grid'
                name: 'cose',
                idealEdgeLength: 200,
                nodeOverlap: 20,
                refresh: 20,
                fit: true,
                padding: 30,
                randomize: false,
                componentSpacing: 100,
                nodeRepulsion: 400000,
                edgeElasticity: 100,
                nestingFactor: 5,
                gravity: 80,
                numIter: 1000,
                initialTemp: 200,
                coolingFactor: 0.95,
                minTemp: 1.0
            }
        });

        cy.htmlLabel([
            {
                query: 'edge',
                halign: 'center',
                valign: 'center',
                halignBox: 'center',
                valignBox: 'center',
                tpl: function (data) {
                    if (data.type == 'filter') {
                        return `
                            <div class="edge-label-filter">
                                <span>${data.label}</span>
                                <br />
                                <br />
                                <span style="font-weight: bold; color:white">${data.filterType}</span>
                                <br />
                            </div>
                        `;
                    }

                    return `<div class="edge-label${data.type ? `-${data.type}` : ''}">${data.label}</div>`;
                }
            },
            {
                query: 'node',
                halign: 'center',
                valign: 'center',
                halignBox: 'center',
                valignBox: 'center',
                tpl: function (data) {
                    let finalLabel = data.label;
                    let lengthClass = finalLabel.length > 15 ? " node-label-big" : "";
                    if (data.label.includes(')')) {
                        finalLabel = finalLabel.split(')')[1].trimStart()
                    }
                    return `<div class="node-label${data.type == 'variable' ? '-variable' : ''} ${lengthClass}">${finalLabel}</div>`;
                }
            }
        ]);

        cy.cxtmenu({
            selector: 'node',
            adaptativeNodeSpotlightRadius: true,
            commands: [
                // {
                //     content: '<span class="fa fa-flash fa-2x"></span>',
                //     select: function (ele) {
                //         console.log(ele.id());
                //     }
                // },

                // {
                //     content: '<span class="fa fa-star fa-2x"></span>',
                //     select: function (ele) {
                //         console.log(ele.data('name'));
                //     },
                //     enabled: false
                // },
                {
                    content: 'Cancel',
                    select: function (ele) {

                    }
                },
                {
                    content: 'Remove',
                    select: function (ele) {
                        cy.edges().forEach(function (edge) {
                            if ([edge.data('source'), edge.data('target')].includes(ele.id())) {
                                edge.remove();
                            }
                        });

                        ele.remove();
                    }
                },
                {
                    content: 'Convert to variable',
                    select: function (ele) {
                        let oldId = ele.id();
                        let newNodeVarId = '?node_' + (new Date().getTime());

                        var oldNodeData = ele.data();
                        var oldNodePosition = ele.position();
                        let newData = Object.assign({}, oldNodeData, { id: newNodeVarId, value: newNodeVarId, label: '?', type: 'variable' });

                        cy.add({
                            group: 'nodes',
                            data: newData,
                            position: oldNodePosition
                        });

                        cy.edges().forEach(function (edge) {
                            if (edge.data('source') === oldId) {
                                let oldEdgeId = edge.data('id');
                                let oldEdgeTarget = edge.data('target');
                                let oldEdgeLabel = edge.data('label');
                                let oldEdgeNodeId = edge.data('nodeId');
                                edge.remove();
                                cy.add(
                                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: newNodeVarId, target: oldEdgeTarget } }
                                )
                            }

                            if (edge.data('target') === oldId) {
                                let oldEdgeId = edge.data('id');
                                let oldEdgeSource = edge.data('source');
                                let oldEdgeLabel = edge.data('label');
                                let oldEdgeNodeId = edge.data('nodeId');
                                edge.remove();
                                cy.add(
                                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: oldEdgeSource, target: newNodeVarId } }
                                )
                            }
                        });

                        ele.remove();
                    }
                }
            ]
        });

        // cy.cxtmenu({
        //     selector: 'edge',
        //     adaptativeNodeSpotlightRadius: true,
        //     commands: [
        //         {
        //             content: 'Convert to variable',
        //             select: function (ele) {

        //             }
        //         }
        //     ]
        // });

        var isDraggingNewNode = false;
        let originalPosition = null;
        var sourceNode = null;

        cy.on('drag', 'node', function (event) {
            if (isDraggingNewNode) {
                sourceNode.position.x = originalPosition.x;
                sourceNode.position.y = originalPosition.y;
            }
        });

        cy.on('mousedown', 'node', function (event) {
            sourceNode = event.target._private;

            if (event.originalEvent.altKey) {
                isDraggingNewNode = true;
                originalPosition = {
                    x: sourceNode.position.x,
                    y: sourceNode.position.y
                };
            }
        });

        cy.on('mouseup', function (event) {
            if (isDraggingNewNode && event.originalEvent.altKey) {
                const releasedPosition = event.position;

                let nearbyNode = cy.nodes().filter(function (node) {
                    let nodePosition = node._private.position;
                    let distance = Math.sqrt(Math.pow(nodePosition.x - releasedPosition.x, 2) + Math.pow(nodePosition.y - releasedPosition.y, 2));

                    // Aqui estamos usando 30 como um limite arbitrário para proximidade
                    return distance < 30;
                }).first();


                if (nearbyNode.length) {
                    // Conecte ao nó existente
                    cy.add({
                        group: 'edges',
                        data: { source: sourceNode.data.id, target: nearbyNode.id(), label: '?someProp', type: 'variable' }
                    });
                } else {
                    const newNodeId = '?node_' + (new Date().getTime());
                    cy.add([
                        { group: 'nodes', data: { id: newNodeId, value: newNodeId, label: '?', type: 'variable' }, position: releasedPosition },
                        { group: 'edges', data: { id: '?edge-' + (cy.edges().length + 1), label: '?', source: sourceNode.data.id, target: newNodeId, type: 'variable' } }
                    ]);
                }

                isDraggingNewNode = false;
                sourceNode = null;
                originalPosition = null;
            }
        });

        cy.on('mouseout', 'node', function (event) {
            if (isDraggingNewNode) {
                isDraggingNewNode = false;
                sourceNode = null;
                originalPosition = null;
            }
        });

        cy.on('tap', function (event) {
            var privateData = event.target._private;
            console.log(privateData)

            changeElementBooleanValue(event.target)
            changeElementStringValueModal(event.target)

            if (privateData.data.isLink) {
                window.open(privateData.data.href, '_blank');
                return;
            }

            if (privateData.data.type == 'node') {
                getElementInfo(privateData.data.value)
            }

            if (privateData.data.type == 'filter') {
                showColorModal(privateData);
            }

            if (privateData.data.type == 'default') {
                var varName = '?default_' + (new Date().getTime());
                getQuery(varName, [
                    {
                        subject: varName,
                        predicate: "rdfs:domain",
                        object: privateData.data.value,
                    }
                ], false, 'getRelationshipValue');
            }

            if (privateData.data.type == 'variable') {
                let conjuntos = cy.elements().components();
                let conjuntoQuery = null;
                for (var i = 0; i < conjuntos.length; i++) {
                    for (var j = 0; j < conjuntos[i].length; j++) {
                        if (privateData.data.id == conjuntos[i][j]._private.data.id) {
                            conjuntoQuery = i;
                            break;
                        }
                    }
                }

                let filtros = [];
                for (var i = 0; i < conjuntos[conjuntoQuery].length; i++) {
                    var item = conjuntos[conjuntoQuery][i];
                    if (item.data('source') && item.data('target')) {

                        // Busca o valor dos elementos com o id do `source` e `target`
                        let sourceNode = cy.getElementById(item.data('source'));
                        let targetNode = cy.getElementById(item.data('target'));
                        let sourceValue = sourceNode.data('value') || item.data('source'); // Pega `value` ou `id`
                        let targetValue = targetNode.data('value') || item.data('target'); // Pega `value` ou `id`
                        let targetFilter = targetNode.data('filterType') || null

                        // Adiciona o filtro com os valores dos nós `source` e `target`
                        filtros.push({
                            subject: sourceValue,
                            predicate: item.data('nodeId') || '?empty_' + (new Date().getTime()),
                            object: targetValue,
                            filterType: targetFilter ? +targetFilter : null
                        });
                    }
                }

                getQuery(privateData.data.value, filtros, true);
            }
        });

        function changeElementBooleanValue(ele) {
            if (ele.data('label') != 'true' && ele.data('label') != 'false') {
                return;
            }

            // Verifica se o nó `source` do elemento tem `data('type') == 'variable'`
            let sourceEdges = cy.edges().filter(edge => edge.data('target') === ele.id() && cy.getElementById(edge.data('source')).data('type') === 'variable');

            // Se não houver uma origem com `type: variable`, sai da função
            if (sourceEdges.length === 0) {
                return;
            }

            let newNodeId = 'node_' + (new Date().getTime());
            let oldId = ele.id();
            var oldNodeData = ele.data();
            var oldNodePosition = ele.position();
            var newValue = ele.data('label') == 'true' ? 'false' : 'true';

            let newData = Object.assign({}, oldNodeData, { id: newNodeId, label: newValue, value: newValue });

            cy.add({
                group: 'nodes',
                data: newData,
                position: oldNodePosition
            });

            cy.edges().forEach(function (edge) {
                if (edge.data('source') === oldId) {
                    let oldEdgeId = edge.data('id');
                    let oldEdgeTarget = edge.data('target');
                    let oldEdgeLabel = edge.data('label');
                    let oldEdgeNodeId = edge.data('nodeId');
                    edge.remove();
                    cy.add(
                        { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: newNodeId, target: oldEdgeTarget } }
                    )
                }

                if (edge.data('target') === oldId) {
                    let oldEdgeId = edge.data('id');
                    let oldEdgeSource = edge.data('source');
                    let oldEdgeLabel = edge.data('label');
                    let oldEdgeNodeId = edge.data('nodeId');
                    edge.remove();
                    cy.add(
                        { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: oldEdgeSource, target: newNodeId } }
                    )
                }
            });

            ele.remove();
        }

        function changeElementStringValueModal(ele) {
            if (ele.data('type') != 'label') {
                return;
            }

            // Verifica se o nó `source` do elemento tem `data('type') == 'variable'`
            let sourceEdges = cy.edges().filter(edge => edge.data('target') === ele.id() && cy.getElementById(edge.data('source')).data('type') === 'variable');

            // Se não houver uma origem com `type: variable`, sai da função
            if (sourceEdges.length === 0) {
                return;
            }

            var theValue = ele.data('label');
            var theId = ele.id();
            $('#modal-change-value-content').html(getModalReplaceContent(theId, theValue));

            abrirModalChangeValue();
        }
    });

    function getModalReplaceContent(theId, theValue) {
        let content = '';

        if (isNaN(theValue) && theValue != "MAX" && theValue != "MIN")
            content = `
            <p>Current value: ${theValue}</p>
            <div>
                <label for="new-value">New Value</label>
                <input type="text" id="new-value" placeholder="Enter new value" value="${theValue}">
            </div>
            <div>
                <label>Filter Type:</label>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="" checked>
                        <span>Exact match</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="0">
                        <span>Starts with</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="1">
                        <span>Contains</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" id="confirm-btn" onclick="changeElementStringValue('${theId}', $('#new-value').val(), $('input[name=filter-type]:checked').val())" class="waves-effect waves-green btn-flat blue white-text">OK</a>
            </div>
            `;
        else
            content = `
            <p>Current value: ${theValue}</p>
            <div>
                <label for="new-value">New Value</label>
                <input type="text" id="new-value" placeholder="Enter new value" value="${theValue}">
            </div>
            <div>
                <label>Filter Type:</label>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="" checked>
                        <span>Exactly Equal</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="2">
                        <span>Greater Than</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="3">
                        <span>Lesser Than</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="4">
                        <span>MAX</span>
                    </label>
                </div>
                <div>
                    <label>
                        <input type="radio" name="filter-type" value="5">
                        <span>MIN</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" id="confirm-btn" onclick="changeElementStringValue('${theId}', $('#new-value').val(), $('input[name=filter-type]:checked').val())" class="waves-effect waves-green btn-flat blue white-text">OK</a>
            </div>
        `;

        return content;
    }

    function changeElementStringValue(elementId, newValue, filterType) {
        let ele = cy.getElementById(elementId);
        let newNodeId = 'node_' + (new Date().getTime());
        let oldId = ele.id();
        var oldNodeData = ele.data();
        var oldNodePosition = ele.position();
        var label = newValue;
        if (filterType == 4 || filterType == 5) {
            label = filterType == 4 ? "MAX" : "MIN";
        }

        let newData = Object.assign({}, oldNodeData, { id: newNodeId, label: label, value: newValue, filterType: filterType });

        cy.add({
            group: 'nodes',
            data: newData,
            position: oldNodePosition
        });

        cy.edges().forEach(function (edge) {
            if (edge.data('source') === oldId) {
                let oldEdgeId = edge.data('id');
                let oldEdgeTarget = edge.data('target');
                let oldEdgeLabel = edge.data('label');
                let oldEdgeNodeId = edge.data('nodeId');
                edge.remove();
                cy.add(
                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: newNodeId, target: oldEdgeTarget } }
                )
            }

            if (edge.data('target') === oldId) {
                let oldEdgeId = edge.data('id');
                let oldEdgeSource = edge.data('source');
                let oldEdgeLabel = edge.data('label');
                let oldEdgeNodeId = edge.data('nodeId');
                edge.remove();
                cy.add(
                    { group: 'edges', data: { nodeId: oldEdgeNodeId, id: oldEdgeId, label: oldEdgeLabel, source: oldEdgeSource, target: newNodeId } }
                )
            }
        });

        ele.remove();

        $('#modal-change-value').modal('close');
    }

    function escapeHTML(unsafeText) {
        return unsafeText
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</html>